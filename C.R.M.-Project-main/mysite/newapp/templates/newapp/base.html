<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}CRM System{% endblock %}</title>
    <link rel="stylesheet" href="{% static 'newapp/css/balanced.css' %}?v=3">
    <!-- JavaScript Utilities -->
    <script src="{% static 'newapp/js/utils.js' %}?v=20241201-2"></script>
    <script src="{% static 'newapp/js/dashboard.js' %}?v=20241201-2"></script>
    <script src="{% static 'newapp/js/forms.js' %}?v=20241201-2"></script>
    <script src="{% static 'newapp/js/list-optimization.js' %}?v=20241201-2"></script>
    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- Header -->
    <header class="crm-header">
    <div class="header-left">
        <button class="sidebar-toggle" id="sidebarToggle">
            <span>â˜°</span>
        </button>
        <div class="header-brand">
            <a href="{% url 'newapp:dashboard' %}" style="text-decoration: none; color: inherit;">
                <strong>CRM System</strong>
            </a>
        </div>
    </div>

    <div class="header-user">
        <span class="user-name">ğŸ‘¤ {{ user.get_full_name|default:user.username }}</span>
        <a href="{% url 'newapp:logout' %}" class="logout-link">Logout</a>
    </div>
</header>

    <!-- Sidebar Navigation -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3>ğŸ“Š Navigation</h3>
        </div>
        <nav class="sidebar-nav">
            <a href="{% url 'newapp:dashboard' %}{% if request.GET.view_as_user %}?view_as_user={{ request.GET.view_as_user }}{% endif %}" {% if request.resolver_match.url_name == 'dashboard' %}class="active"{% endif %}>
                <span class="nav-icon">ğŸ“Š</span>
                <span class="nav-text">Dashboard</span>
            </a>
            <a href="{% url 'newapp:visit_management' %}{% if request.GET.view_as_user %}?view_as_user={{ request.GET.view_as_user }}{% endif %}" {% if 'visit' in request.resolver_match.url_name and 'report' not in request.resolver_match.url_name %}class="active"{% endif %}>
                <span class="nav-icon">ğŸ“…</span>
                <span class="nav-text">Visit Management</span>
            </a>
            <a href="{% url 'newapp:lead_list' %}{% if request.GET.view_as_user %}?view_as_user={{ request.GET.view_as_user }}{% endif %}" {% if 'lead' in request.resolver_match.url_name %}class="active"{% endif %}>
                <span class="nav-icon">ğŸ¯</span>
                <span class="nav-text">Lead Management</span>
            </a>
            <a href="{% url 'newapp:activity_dashboard' %}{% if request.GET.view_as_user %}?view_as_user={{ request.GET.view_as_user }}{% endif %}" {% if 'activity' in request.resolver_match.url_name %}class="active"{% endif %}>
                <span class="nav-icon">âš¡</span>
                <span class="nav-text">Activity Tracker</span>
            </a>
            <a href="{% url 'newapp:quotation_list' %}{% if request.GET.view_as_user %}?view_as_user={{ request.GET.view_as_user %}{% endif %}" {% if 'quotation' in request.resolver_match.url_name %}class="active"{% endif %}>
                <span class="nav-icon">ğŸ’°</span>
                <span class="nav-text">Quotations</span>
            </a>
            <a href="{% url 'newapp:salesorder_list' %}{% if request.GET.view_as_user %}?view_as_user={{ request.GET.view_as_user }}{% endif %}" {% if 'salesorder' in request.resolver_match.url_name %}class="active"{% endif %}>
                <span class="nav-icon">ğŸ“¦</span>
                <span class="nav-text">Sales Orders</span>
            </a>
            <a href="{% url 'newapp:servicecall_list' %}{% if request.GET.view_as_user %}?view_as_user={{ request.GET.view_as_user }}{% endif %}" {% if 'servicecall' in request.resolver_match.url_name %}class="active"{% endif %}>
                <span class="nav-icon">ğŸ”§</span>
                <span class="nav-text">Service Calls</span>
            </a>
            <a href="{% url 'newapp:visit_report' %}{% if request.GET.view_as_user %}?view_as_user={{ request.GET.view_as_user }}{% endif %}" {% if 'report' in request.resolver_match.url_name %}class="active"{% endif %}>
                <span class="nav-icon">ğŸ“ˆ</span>
                <span class="nav-text">Reports</span>
            </a>
            {% if user.is_staff %}
            <div class="sidebar-divider"></div>
            <a href="/admin/" {% if '/admin/' in request.path %}class="active"{% endif %}>
                <span class="nav-icon">âš™ï¸</span>
                <span class="nav-text">Admin Panel</span>
            </a>
            {% endif %}
        </nav>
    </aside>

    <!-- Main Layout Wrapper -->
    <div class="main-wrapper">
        <!-- Admin User Selection Panel -->
        {% if user.is_staff or user.is_superuser %}
        <div class="admin-user-panel">
            <div class="admin-user-panel-content">
                <form method="get" class="admin-user-form">
                    <label class="admin-user-label">
                        ğŸ‘¥ View User Activity:
                    </label>
                    <select name="view_as_user" onchange="this.form.submit()" class="admin-user-select">
                        <option value="self" {% if not request.GET.view_as_user or request.GET.view_as_user == 'self' %}selected{% endif %}>ğŸ“Š All Users / My View (Admin)</option>
                        <option disabled>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</option>
                        {% for emp in all_employees %}
                            <option value="{{ emp.user.id }}" {% if request.GET.view_as_user == emp.user.id|stringformat:"s" %}selected{% endif %}>
                                ğŸ‘¤ {{ emp.user.get_full_name|default:emp.user.username }} - {{ emp.get_role_display }}
                            </option>
                        {% endfor %}
                    </select>
                    {% if viewing_as %}
                    <a href="?view_as_user=self" class="admin-clear-btn">
                        âœ– Clear Selection
                    </a>
                    {% endif %}
                </form>
                {% if viewing_as %}
                <div class="admin-viewing-banner">
                    ğŸ‘ï¸ Currently viewing activity for: <strong>{{ viewing_as }}</strong>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Main Content -->
        <main class="page-content">
            {% if messages %}
                <div class="messages">
                    {% for message in messages %}
                        <div class="message {{ message.tags }}">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}
            
            {% block content %}{% endblock %}
        </main>
    </div>

    <!-- Sidebar Toggle Script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const mainWrapper = document.querySelector('.main-wrapper');
            
            // Toggle sidebar
            sidebarToggle.addEventListener('click', function() {
                sidebar.classList.toggle('collapsed');
                document.body.classList.toggle('sidebar-collapsed');
            });
            
            // Close sidebar on mobile when clicking outside
            document.addEventListener('click', function(event) {
                if (window.innerWidth <= 768) {
                    if (!sidebar.contains(event.target) && !sidebarToggle.contains(event.target)) {
                        sidebar.classList.remove('mobile-open');
                    }
                }
            });
            
            // Mobile toggle
            if (window.innerWidth <= 768) {
                sidebarToggle.addEventListener('click', function(e) {
                    e.stopPropagation();
                    sidebar.classList.toggle('mobile-open');
                });
            }
        });
    </script>
    {% block extra_js %}{% endblock %}
</body>
</html>
