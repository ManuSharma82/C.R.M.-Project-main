{% extends 'newapp/base.html' %}
{% load static %}

{% block title %}Visit Reports - CRM System{% endblock %}

{% block content %}
    <div class="page-header">
        <div>
            <h1>üìä Visit Reports & Analytics</h1>
        </div>
        <div class="page-header-actions">
            <button onclick="window.print()" class="btn btn-secondary">üñ®Ô∏è Print Report</button>
        </div>
    </div>

    <!-- Date Filter -->
    <div class="filter-section">
        <form method="get" class="filter-form">
            <div class="form-group">
                <label>From Date</label>
                <input type="date" name="start_date" value="{{ start_date }}" class="form-input">
            </div>
            <div class="form-group">
                <label>To Date</label>
                <input type="date" name="end_date" value="{{ end_date }}" class="form-input">
            </div>
            <div class="form-group">
                <label>&nbsp;</label>
                <button type="submit" class="btn btn-primary">Generate Report</button>
            </div>
            <div class="form-group">
                <label>&nbsp;</label>
                <a href="{% url 'newapp:visit_report' %}" class="btn btn-secondary">Reset</a>
            </div>
        </form>
    </div>

    <!-- Summary Statistics -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label">Total Visits</div>
            <div class="stat-number">{{ total_visits }}</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-label">Completed</div>
            <div class="stat-number" style="background: linear-gradient(135deg, var(--success-color) 0%, #34d399 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">{{ completed_visits }}</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-label">Pending Approval</div>
            <div class="stat-number" style="background: linear-gradient(135deg, var(--warning-color) 0%, #fbbf24 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">{{ pending_approvals }}</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-label">Success Rate</div>
            <div class="stat-number" style="background: linear-gradient(135deg, var(--info-color) 0%, #38bdf8 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">{{ success_rate }}%</div>
        </div>
    </div>

    <!-- Outcome Breakdown -->
    <div class="section">
        <h2>Visit Outcomes Breakdown</h2>
        <div class="report-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-md);">
            <div class="report-item" style="background: linear-gradient(135deg, #d1fae5 0%, white 100%); padding: var(--spacing-md); border-radius: var(--radius-md); border-left: 4px solid var(--success-color);">
                <div class="report-label" style="font-weight: 600; color: var(--text-dark);">Positive</div>
                <div class="report-value" style="font-size: 1.8em; font-weight: 800; color: var(--success-color);">{{ positive_outcomes }}</div>
            </div>
            
            <div class="report-item" style="background: linear-gradient(135deg, #dbeafe 0%, white 100%); padding: var(--spacing-md); border-radius: var(--radius-md); border-left: 4px solid var(--info-color);">
                <div class="report-label" style="font-weight: 600; color: var(--text-dark);">Neutral</div>
                <div class="report-value" style="font-size: 1.8em; font-weight: 800; color: var(--info-color);">{{ neutral_outcomes }}</div>
            </div>
            
            <div class="report-item" style="background: linear-gradient(135deg, #fee2e2 0%, white 100%); padding: var(--spacing-md); border-radius: var(--radius-md); border-left: 4px solid var(--danger-color);">
                <div class="report-label" style="font-weight: 600; color: var(--text-dark);">Negative</div>
                <div class="report-value" style="font-size: 1.8em; font-weight: 800; color: var(--danger-color);">{{ negative_outcomes }}</div>
            </div>
            
            <div class="report-item" style="background: linear-gradient(135deg, #e0f2fe 0%, white 100%); padding: var(--spacing-md); border-radius: var(--radius-md); border-left: 4px solid var(--primary-color);">
                <div class="report-label" style="font-weight: 600; color: var(--text-dark);">Deal Closed</div>
                <div class="report-value" style="font-size: 1.8em; font-weight: 800; color: var(--primary-color);">{{ deals_closed }}</div>
            </div>
            
            <div class="report-item" style="background: linear-gradient(135deg, #fef3c7 0%, white 100%); padding: var(--spacing-md); border-radius: var(--radius-md); border-left: 4px solid var(--warning-color);">
                <div class="report-label" style="font-weight: 600; color: var(--text-dark);">Follow-up Required</div>
                <div class="report-value" style="font-size: 1.8em; font-weight: 800; color: var(--warning-color);">{{ follow_ups }}</div>
            </div>
        </div>
    </div>

    <!-- Status Breakdown -->
    <div class="section">
        <h2>Visit Status Distribution</h2>
        <div class="detail-grid">
            <div class="detail-item">
                <strong>Scheduled Visits</strong>
                <span style="font-size: 1.5em; font-weight: 700; color: var(--warning-color);">{{ scheduled_visits }}</span>
            </div>
            <div class="detail-item">
                <strong>Completed Visits</strong>
                <span style="font-size: 1.5em; font-weight: 700; color: var(--success-color);">{{ completed_visits }}</span>
            </div>
            <div class="detail-item">
                <strong>Cancelled Visits</strong>
                <span style="font-size: 1.5em; font-weight: 700; color: var(--danger-color);">{{ cancelled_visits }}</span>
            </div>
        </div>
    </div>

    <!-- Employee Performance -->
    {% if employee_performance %}
    <div class="section">
        <h2>Employee Performance</h2>
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Employee</th>
                        <th>Total Visits</th>
                        <th>Completed</th>
                        <th>Pending</th>
                        <th>Success Rate</th>
                    </tr>
                </thead>
                <tbody>
                    {% for emp in employee_performance %}
                    <tr>
                        <td>
                            <strong>{{ emp.employee__user__first_name }} {{ emp.employee__user__last_name }}</strong><br>
                            <small style="color: var(--text-light);">{{ emp.employee__employee_id }}</small>
                        </td>
                        <td><span class="badge badge-primary">{{ emp.total }}</span></td>
                        <td><span class="badge badge-status-completed">{{ emp.completed }}</span></td>
                        <td><span class="badge badge-pending">{{ emp.pending }}</span></td>
                        <td>
                            {% if emp.success_rate %}
                                <strong style="color: var(--success-color);">{{ emp.success_rate }}%</strong>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Recent Visit Details -->
    <div class="section">
        <h2>Recent Visits</h2>
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Visit ID</th>
                        <th>Prospect</th>
                        <th>Employee</th>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Outcome</th>
                        <th>Approval</th>
                    </tr>
                </thead>
                <tbody>
                    {% for visit in recent_visits %}
                    <tr>
                        <td><strong>{{ visit.visit_id }}</strong></td>
                        <td>
                            {{ visit.prospect.name }}<br>
                            <small style="color: var(--text-light);">{{ visit.prospect.company_name|default:"Individual" }}</small>
                        </td>
                        <td>{{ visit.sales_employee.user.get_full_name }}</td>
                        <td>{{ visit.visit_date }}</td>
                        <td><span class="badge badge-status-{{ visit.status|lower }}">{{ visit.get_status_display }}</span></td>
                        <td>
                            {% if visit.outcome_type %}
                                <span class="badge badge-outcome-{{ visit.outcome_type|lower }}">{{ visit.get_outcome_type_display }}</span>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td><span class="badge badge-{{ visit.approval_status|lower }}">{{ visit.get_approval_status_display }}</span></td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: var(--text-light);">
                            No visits found for the selected date range
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Summary Note -->
    <div class="alert alert-info" style="margin-top: var(--spacing-xl);">
        <strong>üìù Report Summary:</strong> This report shows visit data 
        {% if start_date and end_date %}
            from <strong>{{ start_date }}</strong> to <strong>{{ end_date }}</strong>.
        {% else %}
            for all time.
        {% endif %}
        Generated on {{ now|date:"F d, Y \a\t H:i" }}.
    </div>
{% endblock %}
